# eubucco

EUBUCCO is a scientific database of individual building footprints for buildings across the 27 European Union countries
and Switzerland.

[![Built with Cookiecutter Django](https://img.shields.io/badge/built%20with-Cookiecutter%20Django-ff69b4.svg?logo=cookiecutter)](https://github.com/cookiecutter/cookiecutter-django/)
[![Black code style](https://img.shields.io/badge/code%20style-black-000000.svg)](https://github.com/ambv/black)

License: MIT

## Settings

Moved to [settings](http://cookiecutter-django.readthedocs.io/en/latest/settings.html).

## pre-commit

We are using [pre-commit](https://pre-commit.com/) to uphold certain formatting standards. Please check out the link to
find out how to use/install it on your system.

## Basic Commands

### Getting Up and Running Locally With Docker

Full Guide can be found
here: [Getting Up and Running Locally With Docker](https://cookiecutter-django.readthedocs.io/en/latest/developing-locally-docker.html)

#### Start the server with:

    docker compose -f local.yml up

#### Rebuild the images & Start

    docker compose -f local.yml up --build

## Data lake: MinIO + Parquet + DuckDB

- Object storage: `local.yml` now starts a MinIO server on `9000` (S3 API) and `9001` (console) with a bucket named `eubucco` created by the `minio-setup` sidecar.
- Ingestion: run `publish_parquet_partitions` to transform the zipped GPKG sources into Parquet partitioned by `nuts_id` and upload them to MinIO.
    ```bash
    docker compose -f local.yml run --rm django \
      python manage.py shell -c "from eubucco.ingest.tasks import publish_parquet_partitions; publish_parquet_partitions(chunk_size=20000)"
    ```
  Add an optional `csvs/util/nuts_lookup.csv` (columns: `country,region,city,nuts_level,nuts_id`) to control the NUTS mapping; otherwise regions are used as the partition key.
- If you already have per-NUTS3 Parquet files (filename is the NUTS3 code, e.g. `ES300.parquet`), drop them into `csvs/buildings_parquet/` and push them straight to MinIO without conversion:
    ```bash
    docker compose -f local.yml run --rm django \
      python manage.py shell -c "from eubucco.ingest.tasks import stage_existing_parquet; stage_existing_parquet(version_tag='v0_1')"
    ```
- Public endpoint for presigned links: set `MINIO_PUBLIC_ENDPOINT` (default in local.yml is `http://localhost:9000`) so browser downloads donâ€™t point at the internal `minio:9000` host.
- NUTS vector tiles for the map UI: place `nuts.pmtiles` in `./tiles/` before `docker compose up`; the `minio-setup` job uploads it to MinIO and the UI reads it from `${NUTS_PM_TILES_URL}` (defaults to `${MINIO_PUBLIC_ENDPOINT}/nuts.pmtiles`).
  Make sure the URL includes the bucket, e.g. `http://localhost:9000/eubucco/nuts.pmtiles` (local.yml sets this by default).
  If you also place `pmtiles.js` in `./tiles/`, it will be uploaded and served from MinIO (set `PMTILES_JS_URL` or rely on the default), avoiding external CDNs.
- API discovery: `GET http://localhost:8001/v0.1/datalake/nuts` lists available partitions; `GET http://localhost:8001/v0.1/datalake/nuts/<version>/<nuts_id>` returns presigned links for one partition.
- DuckDB example for a local subset:
    ```bash
    duckdb -c "INSTALL httpfs; LOAD httpfs;
    SET s3_endpoint='http://localhost:9000';
    SET s3_access_key_id='minioadmin';
    SET s3_secret_access_key='minioadmin';
    SET s3_use_ssl=false;
    SELECT count(*) FROM read_parquet('s3://eubucco/buildings/v0_1/nuts_id=CY00/*.parquet');"
    ```

### Setting Up Your Users

- To create a **normal user account**, just go to Sign Up and fill out the form. Once you submit it, you'll see a "
  Verify Your E-mail Address" page. Go to your console to see a simulated email verification message. Copy the link into
  your browser. Now the user's email should be verified and ready to go.

- To create a **superuser account**, use this command:

      docker compose -f local.yml run --rm django python manage.py createsuperuser

To access the email verification message go to `http://localhost:8025/` where Mailhog is running and confirm the email
of the user there. A superuser can log into the admin panel without verification but not into the normal site.

For convenience, you can keep your normal user logged in on Chrome and your superuser logged in on Firefox (or similar),
so that you can see how the site behaves for both kinds of users.

---

# From here on the doc is autogenerated, commands might not work in our instance!

---

### Type checks

Running type checks with mypy:

    $ mypy eubucco

### Test coverage

To run the tests, check your test coverage, and generate an HTML coverage report:

    $ coverage run -m pytest
    $ coverage html
    $ open htmlcov/index.html

#### Running tests with pytest

    $ pytest

### Live reloading and Sass CSS compilation

Moved
to [Live reloading and SASS compilation](https://cookiecutter-django.readthedocs.io/en/latest/developing-locally.html#sass-compilation-live-reloading)
.

### Celery

This app comes with Celery.

To run a celery worker:

``` bash
cd eubucco
celery -A config.celery_app worker -l info
```

Please note: For Celery's import magic to work, it is important *where* the celery commands are run. If you are in the
same folder with *manage.py*, you should be right.

### Email Server

In development, it is often nice to be able to see emails that are being sent from your application. For that reason
local SMTP server [MailHog](https://github.com/mailhog/MailHog) with a web interface is available as docker container.

Container mailhog will start automatically when you will run all docker containers. Please
check [cookiecutter-django Docker documentation](http://cookiecutter-django.readthedocs.io/en/latest/deployment-with-docker.html)
for more details how to start all containers.

With MailHog running, to view messages that are sent by your application, open your browser and go
to `http://127.0.0.1:8025`

### Sentry

Sentry is an error logging aggregator service. You can sign up for a free account
at <https://sentry.io/signup/?code=cookiecutter> or download and host it yourself. The system is set up with reasonable
defaults, including 404 logging and integration with the WSGI application.

You must set the DSN url in production.

## Deployment

The following details how to deploy this application.

### Docker

See
detailed [cookiecutter-django Docker documentation](http://cookiecutter-django.readthedocs.io/en/latest/deployment-with-docker.html)
.
