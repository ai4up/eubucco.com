{% extends "base.html" %}
{% load static %}

{#Update and include https://github.com/maplibre/martin#using-with-maplibre !!!#}

{% block content %}
  <html>
  <head>
    <meta charset='utf-8'/>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <script src="https://unpkg.com/maplibre-gl@2.1.9/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@2.1.9/dist/maplibre-gl.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style type="text/css">
      body {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
      }

      #map {
        position: absolute;
        top: 110px;
        bottom: 64px;
        left: 0;
        right: 0;
      }

      .map-popup, .mapboxgl-popup-content, .maplibregl-popup-content {
        background-color: hsl(var(--b1));
      }

      .maplibregl-popup-tip, .mapboxgl-popup-tip {
        background-color: transparent;
      }

      #meta {
        z-index: 2;
        color: hsl(var(--bc));
        background: hsl(var(--b1));
        position: absolute;
        top: -10;
        left: 50%;
        padding: 10 20;
        margin: 0;
        width: min-content;
      }

      #versionToggle {
        position: absolute;
        right: 20px;
        bottom: 84px;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: hsl(var(--b1));
        border: 1px solid hsl(var(--bc));
        padding: 10px;
        font-weight: bold;
      }

      .versionButton.active {
        background-color: #007BFF;
        color: white;
      }

      #meta h1 {
        margin: 0;
      }

      #meta .properties {
        font-size: 90%;
        width: auto;
      }
    </style>
  </head>
  <body>
    <div class="relative w-full z-[1000]">
      <div class="alert alert-warning rounded-none flex justify-center gap-4 py-2 shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
        <div class="text-center">
          <span class="font-bold">Data Explorer Under Construction!</span>
          <span class="block sm:inline ml-2 text-sm opacity-90">Availability for new <b>v0.2</b> release coming soon.</span>
        </div>
      </div>
    </div>
  {#  <div id="meta">#}
  {#    <h1>public.data_building</h1>#}
  {##}
  {##}
  {#    <hr/>#}
  {#    <p class="properties">age city_id country_id height id id_source region_id type type_source </p>#}
  {##}
  {#  </div>#}

  <div id="map">
    {#    <div id="meta" class="tabs tabs-boxed">#}
    {#      <a class="tab">Off</a>#}
    {#      <a class="tab tab-active">Height</a>#}
    {#      <a class="tab">Type</a>#}
    {#    </div>#}
    <div class="btm-nav z-1">
      <button id="switchChoroplethOff">
        <div class="text-xl">Off</div>
      </button>
      <button id="switchChoroplethHeight" class="active">
        <div class="text-xl">Height</div>
      </button>
      <button id="switchChoroplethAge">
        <div class="text-xl">Age</div>
      </button>
      <button id="switchChoroplethType">
        <div class="text-xl">Type</div>
      </button>
    </div>
  </div>

  <div id='legend' class="absolute bottom-20 left-4 bg-neutral border border-[color:var(--bc)] font-bold">
  </div>
  <div id="versionToggle" class="absolute bottom-20 right-4 bg-neutral border border-[color:var(--bc)] font-bold">
  </div>


  <div id="toast" class="toast toast-center toast-top w-full flex pt-16">
    <div class="alert alert-info justify-center">
      <div class="justify-center">
        <p class="justify-center">Here you can explore the data. Depending on your Zoom level you will see the
          Countries, Region, Cities or Buildings!</p>
      </div>
    </div>
  </div>

  <script>

    var map;
    var paints;
    var mapcolor = "white";
    let currentLayer = null;
    let choroplethChoice = 'height'

    {# hide toast after time#}
    setTimeout(function () {
      document.getElementById("toast").remove();
    }, 10_000);

    $.getJSON("{{ tile_url }}public.data_building.json", function (layer) {

        var mapConfig = {
          'container': 'map',


          'bounds': layer['bounds'],
          'hash': true,
          'style': {
            'version': 8,
            'sources': {
              'open-street': {
                'type': 'raster',
                'tiles': [
                  "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
                  "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
                  "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
                  "https://tile.openstreetmap.org/{z}/{x}/{y}.png"
                ]
              },
              'carto-dark': {
                'type': 'raster',
                'tiles': [
                  "https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png",
                  "https://b.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png",
                  "https://c.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png",
                  "https://d.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png"
                ]
              },
              'carto-light': {
                'type': 'raster',
                'tiles': [
                  "https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png",
                  "https://b.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png",
                  "https://c.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png",
                  "https://d.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png"
                ]
              },
              'wikimedia': {
                'type': 'raster',
                'tiles': [
                  "https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}.png"
                ]
              }
            },
            'layers': [{
              'id': 'carto-layer',
              'source': 'carto-dark',
              'type': 'raster',
              'minzoom': 0,
              'maxzoom': 22
            }]
          }
        };

        var painttypes = {
          "Point": "circle",
          "MultiPoint": "circle",
          "LineString": "line",
          "MultiLineString": "line",
          "Polygon": "fill",
          "MultiPolygon": "fill",
        };

        function layerSource(tileurl) {
          return {
            "type": "vector",
            "tiles": [tileurl],
            "minzoom": layer["minzoom"],
            "maxzoom": layer["maxzoom"]
          }
        };

        function layerId(id, gtype, paint) {
          return id + "." + gtype + "." + paint;
        }

        const heightChoropleth = {
          'fill-color': [
            'interpolate',
            ['linear'],
            ['get', 'height'],
            0,
            '#5e4ea6',
            5,
            '#2f89be',
            10,
            '#62c3a5',
            15,
            '#e6f697',
            20,
            '#fce08c',
            25,
            '#f46d45',
            50,
            '#d3404a',
            1000,
            '#a00042'
          ],
          'fill-opacity': 0.75,
        }

        const ageChoropleth = {
          'fill-color': [
            'interpolate',
            ['linear'],
            ['get', 'age'],
            0,
            '#5e4ea6',
            1900,
            '#2f89be',
            1945,
            '#62c3a5',
            1960,
            '#addda3',
            1970,
            '#e6f697',
            1980,
            '#ffffba',
            1990,
            '#fce08c',
            2000,
            '#f46d45',
            2010,
            '#d3404a',
            2030,
            '#a00042'
          ],
          'fill-opacity': 0.75,
        }

        const typeChoropleth = {
          'fill-color': ['match', ['get', 'type'],
            'RE', 'green',
            'NR', 'red',
            'white'],
          'fill-opacity': 0.75,
        }

        function layerConfig(id, gtype, paint) {
          config = {
            "id": layerId(id, gtype, paint),
            "source": id,
            "source-layer": id,
            "type": paint,
            "filter": ["match", ["geometry-type"], [gtype, "Multi" + gtype], true, false],
          }
          if (id === 'public.data_building' && gtype === 'Polygon' && paint === 'fill') {
            if (choroplethChoice === 'height') {
              config['paint'] = heightChoropleth
            } else if (choroplethChoice === 'type') {
              config['paint'] = typeChoropleth
            } else if (choroplethChoice === 'age') {
              config['paint'] = ageChoropleth
            } else {
              config["paint"] = paints[paint]
            }
          } else {
            config["paint"] = paints[paint]
          }
          return config
        };

        function roundIfNeeded(value) {
          if (typeof value == 'number') {
            return value.toFixed(2)
          }
          return value
        }

        function removeTrailingZero(value) {
          if (typeof value === 'string' || value instanceof String) {
            return value.split('.')[0]
          } else {
            return value
          }
        }

        function typeEnumToString(value) {
          if (value === "RE") {
            return 'Residential'
          } else if (value === "NR") {
            return 'Non-residential'
          } else {
            return 'Unknown'
          }
        }

        function versionEnumToString(value) {
          if (value === 1) {
            return 'v0.1';
          } else if (value === 2) {
            return 'msft24';
          } else {
            return 'Unknown version';
          }
        }

        var versionToggleDiv = document.getElementById('versionToggle');
        var versions = {
          1: 'v0.1',
          2: 'msft24'
        };

        for (var version in versions) {
          var button = document.createElement('button');
          button.textContent = versions[version];
          button.classList.add('versionButton');
          button.dataset.version = version;
          button.id = 'versionButton_' + version;
          versionToggleDiv.appendChild(button);
        }

// Add event listeners to version toggle buttons
        var versionButtons = document.getElementsByClassName('versionButton');
        for (var i = 0; i < versionButtons.length; i++) {
          versionButtons[i].addEventListener('click', function () {
            var version = this.dataset.version;
            toggleVersion(version);
          });
        }


// Function to toggle version visibility
        function toggleVersion(version) {
          var fillFilter = map.getFilter('public.data_building.Polygon.fill');
          var lineFilter = map.getFilter('public.data_building.Polygon.line');
          var versionButtons = document.getElementsByClassName('versionButton');
          for (var j = 0; j < versionButtons.length; j++) {
            versionButtons[j].classList.remove('active');
          }
          if (fillFilter && fillFilter[2] == version && lineFilter && lineFilter[2] == version) {
            // If a filter for the selected version is already applied, remove it
            map.setFilter('public.data_building.Polygon.fill', null);
            map.setFilter('public.data_building.Polygon.line', null);
            button = document.getElementById('versionButton_' + version);
            button.classList.remove('active');
          } else {
            // If not, apply the filter to only show the buildings of the selected version
            map.setFilter('public.data_building.Polygon.fill', ['==', 'version', parseInt(version)]);
            map.setFilter('public.data_building.Polygon.line', ['==', 'version', parseInt(version)]);
            button = document.getElementById('versionButton_' + version);
            button.classList.add('active');
          }
        }

        function updateLegend() {
          let value = 0
          const legend = document.getElementById("legend");
          legend.replaceChildren()
          let choropleth
          let lastColor = null

          if (choroplethChoice === 'height') {
            choropleth = heightChoropleth
          } else if (choroplethChoice === 'age') {
            choropleth = ageChoropleth
          } else if (choroplethChoice === 'type') {
            choropleth = typeChoropleth
          } else {
            return
          }

          choropleth['fill-color'].forEach(function (item, index) {
              if (choroplethChoice === 'type') {
                index += 1
              }
              if (index > 2) {
                if (index % 2 === 0) {
                  const legendElement = document.createElement("div");
                  const legendGradientElement = document.createElement("div");

                  legendElement.innerHTML = value

                  if (choroplethChoice === 'type') {
                    legendElement.style.backgroundColor = item
                    legendElement.classList.add("p-2")
                  }

                  if (lastColor == null && choroplethChoice !== 'type') {
                    let firstElement = document.createElement("div")
                    firstElement.classList.add('h-2')
                    firstElement.style.background = item
                    legend.append(firstElement)
                  } else {
                    if (choroplethChoice !== 'type') {
                      legendGradientElement.classList.add('h-4')
                      legendGradientElement.style.background = `linear-gradient(to bottom, ${lastColor}, ${item})`
                    }
                  }

                  legendElement.classList.add('px-2')
                  legendElement.classList.add('text-center')
                  legendElement.classList.add('text-black')
                  legendElement.style.backgroundColor = item


                  legend.append(legendGradientElement)
                  legend.appendChild(legendElement)

                  lastColor = item
                } else {
                  if (choroplethChoice === 'type') {
                    value = typeEnumToString(item)
                  } else {
                    value = item
                  }
                }
              }
            }
          )

          if (choroplethChoice !== 'type') {
            let lastElement = document.createElement("div")
            lastElement.classList.add('h-2')
            lastElement.style.background = lastColor
            legend.append(lastElement)
          }
        }


        function resetLayers() {
          map.removeLayer('public.data_building.Point.circle')
          map.removeLayer('public.data_building.Polygon.fill')
          map.removeLayer('public.data_building.LineString.line')
          map.removeLayer('public.data_building.Polygon.line')
          addOneLayer('public.data_building', 'Polygon')
          updateLegend()
        }

        document.getElementById("switchChoroplethOff").onclick = function () {
          document.getElementById("switchChoroplethOff").classList.add('active')
          document.getElementById("switchChoroplethHeight").classList.remove('active')
          document.getElementById("switchChoroplethType").classList.remove('active')
          document.getElementById("switchChoroplethAge").classList.remove('active')
          choroplethChoice = 'off'
          resetLayers()
        }

        document.getElementById("switchChoroplethHeight").onclick = function () {
          document.getElementById("switchChoroplethHeight").classList.add('active')
          document.getElementById("switchChoroplethOff").classList.remove('active')
          document.getElementById("switchChoroplethType").classList.remove('active')
          document.getElementById("switchChoroplethAge").classList.remove('active')
          choroplethChoice = 'height'
          resetLayers()
        }

        document.getElementById("switchChoroplethAge").onclick = function () {
          document.getElementById("switchChoroplethAge").classList.add('active')
          document.getElementById("switchChoroplethOff").classList.remove('active')
          document.getElementById("switchChoroplethType").classList.remove('active')
          document.getElementById("switchChoroplethHeight").classList.remove('active')
          choroplethChoice = 'age'
          resetLayers()
        }


        document.getElementById("switchChoroplethType").onclick = function () {
          document.getElementById("switchChoroplethType").classList.add('active')
          document.getElementById("switchChoroplethHeight").classList.remove('active')
          document.getElementById("switchChoroplethOff").classList.remove('active')
          document.getElementById("switchChoroplethAge").classList.remove('active')
          choroplethChoice = 'type'
          resetLayers()
        }

        function featureHtml(f) {
          var p = f.properties;
          var h = "<p>";
          for (var k in p) {
            if (k === 'type') {
              value = typeEnumToString(p[k])
            } else if (k === 'id_source' || k === 'age') {
              value = removeTrailingZero(p[k])
            } else if (k === 'version') {
              value = versionEnumToString(p[k]);
            } else {
              value = roundIfNeeded(p[k])
            }

            h += "<b>" + k + ":</b> " + value + "<br/>"
          }
          h += "</p>";
          return h
        }

        function addLayerBehavior(id) {
          map.on('click', id, function (e) {
            new maplibregl.Popup()
              .setLngLat(e.lngLat)
              .setHTML(featureHtml(e.features[0]))
              .addTo(map);
          });


          map.on('mouseenter', id, function () {
            map.getCanvas().style.cursor = 'pointer';
          });


          map.on('mouseleave', id, function () {
            map.getCanvas().style.cursor = '';
          });
        }

        function addOneLayer(id, gtypebasic) {
          map.addLayer(layerConfig(id, gtypebasic, painttypes[gtypebasic]));
          addLayerBehavior(layerId(id, gtypebasic, painttypes[gtypebasic]));
          if (gtypebasic == "Polygon") {
            map.addLayer(layerConfig(id, gtypebasic, "line"));
          }
          map.setPaintProperty('public.data_building.Polygon.line', 'line-color', ['match', ['get', 'version'], 1, 'blue', 2, 'red', 'black']);
        }

        function addLayers(id, gtype, url) {
          map.addSource(id, layerSource(url));
          var gtypebasic = gtype.replace("Multi", "");
          var gtypes = ["Point", "LineString", "Polygon"];

          if (gtypes.includes(gtypebasic)) {
            addOneLayer(id, gtypebasic);
          } else {
            gtypes.forEach(gt => {
              addOneLayer(id, gt);
            });
          }

        }

        function mountMap(dark = true) {
          if (dark === true) {
            mapConfig['style']['layers'][0]['source'] = 'carto-dark'
          } else {
            mapConfig['style']['layers'][0]['source'] = 'carto-light'
          }
          map = new maplibregl.Map(mapConfig);
          map.addControl(new maplibregl.NavigationControl());
          map.on("load", function () {
            updateLegend()

            {#queryParam = new URLSearchParams(window.location.search).toString();#}
            {#if (queryParam.length <= 1) {#}
            {#  queryParam = "";}#}
            queryParam = 'properties=name'
            queryParamBuildings = 'properties=id,id_source,type,type_source,height,age,version'

            tileUrl = layer["tileurl"] + "?" + queryParamBuildings;

            addLayers(layer["id"], layer["geometrytype"], tileUrl);
            onZoom(true)

            $.getJSON("{{ tile_url }}public.data_city.json", function (cityLayer) {
              cityTileUrl = cityLayer["tileurl"] + "?" + queryParam;
              addLayers(cityLayer["id"], cityLayer["geometrytype"], cityTileUrl);
              onZoom(true)
            })

            $.getJSON("{{ tile_url }}public.data_region.json", function (regionLayer) {
              cityTileUrl = regionLayer["tileurl"] + "?" + queryParam;
              addLayers(regionLayer["id"], regionLayer["geometrytype"], cityTileUrl);
              onZoom(true)
            })

            $.getJSON("{{ tile_url }}public.data_country_view.json", function (countryLayer) {
              cityTileUrl = countryLayer["tileurl"] + "?" + queryParam;
              addLayers(countryLayer["id"], countryLayer["geometrytype"], cityTileUrl);
              onZoom(true)
            })

            toggleVersion(1);
            toggleVersion(1);
            toggleVersion(1);
          });
        }

        const runColorMode = (fn) => {
          if (!window.matchMedia) {
            return;
          }

          const query = window.matchMedia('(prefers-color-scheme: dark)');

          fn(query.matches);

          query.addEventListener('change', (event) => fn(event.matches));
        }

        runColorMode((isDarkMode) => {
          let dark
          if (isDarkMode) {
            mapcolor = "white"
            dark = true
          } else {
            mapcolor = "black"
            dark = false
          }

          paints = {
            "circle": {
              "circle-color": mapcolor,
              "circle-radius": 3
            },
            "line": {
              "line-color": mapcolor,
              "line-width": 0.5
            },
            "fill": {
              "fill-color": mapcolor,
              "fill-outline-color": mapcolor,
              "fill-opacity": 0
            }
          };

          mountMap(dark)

        })


        function enableLayer(source) {
          for (const layer of map.getStyle().layers) {
            if (layer['id'].includes('public.data')) {
              if (layer['source'] === source) {
                map.setLayoutProperty(layer['id'], 'visibility', 'visible')
              } else {
                map.setLayoutProperty(layer['id'], 'visibility', 'none')
              }
            }
          }
        }

        function onZoom(force = false) {
          const currentZoom = map.getZoom();
          if (force) {
            currentLayer = null
          }

          if (currentZoom > 12) {
            if (currentLayer !== "public.data_building") {
              enableLayer('public.data_building')
              $('.mapboxgl-popup').remove();
              currentLayer = "public.data_building"
            }


          } else if (currentZoom > 8) {
            if (currentLayer !== "public.data_city") {
              enableLayer('public.data_city')
              $('.mapboxgl-popup').remove();
              currentLayer = "public.data_city"
            }


          } else if (currentZoom > 6) {
            if (currentLayer !== "public.data_region") {
              enableLayer('public.data_region')
              $('.mapboxgl-popup').remove();
              currentLayer = "public.data_region"
            }


          } else {
            if (currentLayer !== "public.data_country_view") {
              enableLayer('public.data_country_view')
              $('.mapboxgl-popup').remove();
              currentLayer = "public.data_country_view"
            }
          }
        }


        map.on('zoom', () => {
          onZoom()
        })
      }
    )
    ;


  </script>

  </body>
  </html>
{% endblock %}
