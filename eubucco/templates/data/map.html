{% extends "base.html" %}
{% load static %}

{#Update and include https://github.com/maplibre/martin#using-with-maplibre !!!#}

{% block content %}
  <html>
  <head>
    <meta charset='utf-8'/>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <script src="https://unpkg.com/maplibre-gl@2.1.9/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@2.1.9/dist/maplibre-gl.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style type="text/css">
      body {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
      }

      #map {
        position: absolute;
        top: 60px;
        bottom: 0;
        left: 0;
        right: 0;
      }

      #meta {
        z-index: 2;
        color: hsl(var(--bc));
        background: hsl(var(--b1));
        position: absolute;
        top: 10;
        left: 20;
        padding: 10 20;
        margin: 0;
        width: min-content;
      }

      #meta h1 {
        margin: 0;
      }

      #meta .properties {
        font-size: 90%;
        width: auto;
      }
    </style>
  </head>
  <body>

  <div id="meta">
    <h1>public.data_building</h1>


    <hr/>
    <p class="properties">age city_id country_id height id id_source region_id type type_source </p>

  </div>

  <div id="map"></div>

  <script>

    var map;
    var mapcolor = "blue";
    let currentLayer = null;


    $.getJSON("{{ tile_url }}public.data_building.json", function (layer) {

      var mapConfig = {
        'container': 'map',


        'bounds': layer['bounds'],
        'hash': true,
        'style': {
          'version': 8,
          'sources': {
            'open-street': {
              'type': 'raster',
              'tiles': [
                "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
                "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
                "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
                "https://tile.openstreetmap.org/{z}/{x}/{y}.png"
              ]
            },
            'carto-dark': {
              'type': 'raster',
              'tiles': [
                "https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png",
                "https://b.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png",
                "https://c.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png",
                "https://d.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png"
              ]
            },
            'carto-light': {
              'type': 'raster',
              'tiles': [
                "https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png",
                "https://b.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png",
                "https://c.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png",
                "https://d.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png"
              ]
            },
            'wikimedia': {
              'type': 'raster',
              'tiles': [
                "https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}.png"
              ]
            }
          },
          'layers': [{
            'id': 'carto-dark-layer',
            'source': 'carto-dark',


            'type': 'raster',
            'minzoom': 0,
            'maxzoom': 22
          }]
        }
      };

      var paints = {
        "circle": {
          "circle-color": mapcolor,
          "circle-radius": 3
        },
        "line": {
          "line-color": mapcolor,
          "line-width": 1.5
        },
        "fill": {
          "fill-color": mapcolor,
          "fill-outline-color": mapcolor,
          "fill-opacity": 0.1
        }
      };

      var painttypes = {
        "Point": "circle",
        "MultiPoint": "circle",
        "LineString": "line",
        "MultiLineString": "line",
        "Polygon": "fill",
        "MultiPolygon": "fill",
      };

      function layerSource(tileurl) {
        return {
          "type": "vector",
          "tiles": [tileurl],
          "minzoom": layer["minzoom"],
          "maxzoom": layer["maxzoom"]
        }
      };

      function layerId(id, gtype, paint) {
        return id + "." + gtype + "." + paint;
      }

      function layerConfig(id, gtype, paint) {
        return {
          "id": layerId(id, gtype, paint),
          "source": id,
          "source-layer": id,
          "type": paint,
          "paint": paints[paint],
          "filter": ["match", ["geometry-type"], [gtype, "Multi" + gtype], true, false]
        }
      };


      function featureHtml(f) {
        var p = f.properties;
        var h = "<p>";
        for (var k in p) {
          h += "<b>" + k + ":</b> " + p[k] + "<br/>"
        }
        h += "</p>";
        return h
      }

      function addLayerBehavior(id) {
        map.on('click', id, function (e) {
          new maplibregl.Popup()
                  .setLngLat(e.lngLat)
                  .setHTML(featureHtml(e.features[0]))
                  .addTo(map);
        });


        map.on('mouseenter', id, function () {
          map.getCanvas().style.cursor = 'pointer';
        });


        map.on('mouseleave', id, function () {
          map.getCanvas().style.cursor = '';
        });
      }

      function addOneLayer(id, gtypebasic) {
        map.addLayer(layerConfig(id, gtypebasic, painttypes[gtypebasic]));
        addLayerBehavior(layerId(id, gtypebasic, painttypes[gtypebasic]));
        if (gtypebasic == "Polygon") {
          map.addLayer(layerConfig(id, gtypebasic, "line"));
        }
      }

      function addLayers(id, gtype, url) {
        map.addSource(id, layerSource(url));
        var gtypebasic = gtype.replace("Multi", "");
        var gtypes = ["Point", "LineString", "Polygon"];

        if (gtypes.includes(gtypebasic)) {
          addOneLayer(id, gtypebasic);
        } else {
          gtypes.forEach(gt => {
            addOneLayer(id, gt);
          });
        }

      }


      map = new maplibregl.Map(mapConfig);
      map.addControl(new maplibregl.NavigationControl());
      map.on("load", function () {

        queryParam = new URLSearchParams(window.location.search).toString();
        if (queryParam.length <= 1) {
          queryParam = "";
        }
        tileUrl = layer["tileurl"] + "?" + queryParam;

        addLayers(layer["id"], layer["geometrytype"], tileUrl);
        onZoom(true)

        $.getJSON("{{ tile_url }}public.data_city.json", function (cityLayer) {
          cityTileUrl = cityLayer["tileurl"] + "?" + queryParam;
          addLayers(cityLayer["id"], cityLayer["geometrytype"], cityTileUrl);
          onZoom(true)
        })

        $.getJSON("{{ tile_url }}public.data_region.json", function (regionLayer) {
          cityTileUrl = regionLayer["tileurl"] + "?" + queryParam;
          addLayers(regionLayer["id"], regionLayer["geometrytype"], cityTileUrl);
          onZoom(true)
        })

        $.getJSON("{{ tile_url }}public.data_country.json", function (countryLayer) {
          cityTileUrl = countryLayer["tileurl"] + "?" + queryParam;
          addLayers(countryLayer["id"], countryLayer["geometrytype"], cityTileUrl);
          onZoom(true)
        })
      });


      function enableLayer(source) {
        for (const layer of map.getStyle().layers) {
          if (layer['id'].includes('public.data')) {
            if (layer['source'] === source) {
              map.setLayoutProperty(layer['id'], 'visibility', 'visible')
            } else {
              map.setLayoutProperty(layer['id'], 'visibility', 'none')
            }
          }
        }
      }

      function onZoom(force = false) {
        const currentZoom = map.getZoom();
        if (force) {
          currentLayer = null
        }

        if (currentZoom > 12) {
          if (currentLayer !== "public.data_building") {
            enableLayer('public.data_building')
            currentLayer = "public.data_building"
          }


        } else if (currentZoom > 8) {
          if (currentLayer !== "public.data_city") {
            enableLayer('public.data_city')
            currentLayer = "public.data_city"
          }


        } else if (currentZoom > 5) {
          if (currentLayer !== "public.data_region") {
            enableLayer('public.data_region')
            currentLayer = "public.data_region"
          }


        } else {
          if (currentLayer !== "public.data_country") {
            enableLayer('public.data_country')
            currentLayer = "public.data_country"
          }
        }
      }


      map.on('zoom', () => {
        onZoom()
      })
    });

  </script>

  </body>
  </html>
{% endblock %}
