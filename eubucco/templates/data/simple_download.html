{% extends "base.html" %}
{% load static %}

{% block content %}
<link href="https://unpkg.com/maplibre-gl@5.14.0/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@5.14.0/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/pmtiles@3.2.0/dist/pmtiles.js"></script>

<style>
  body {
    overflow: hidden !important;
  }
  
  #map { 
    width: 100%;
    height: 100%;
  }
  
  @media (min-width: 768px) {
    .main-container {
      flex-direction: row;
      height: var(--content-height);
      overflow: hidden;
    }
    
    .map-column {
      width: 50%;
      flex-shrink: 0;
      height: 100%;
    }
    
    .map-column > div {
      height: 100%;
    }
    
    .article-column {
      width: 50%;
      height: 100%;
      overflow-y: auto;
    }
  }
  
  @media (max-width: 767px) {
    .map-column > div {
      height: 20rem;
    }
  }
</style>

<div class="main-container w-full flex flex-col gap-6">

  <!-- LEFT COLUMN: MAP -->
  <div class="map-column w-full">
    <div>
      <div id="map"></div>
    </div>
  </div>

  <!-- RIGHT COLUMN: ARTICLE -->
  <article class="article-column w-full">
    <div class="container mx-auto pt-4 px-4 w-full">

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="grid grid-rows-2 grid-flow-col">
          <div class="text-center pb-2"></div>
          <div class="flex gap-4">
            <select class="select select-primary flex-none w-24">
              <option>v0.1</option>
            </select>
            <select id="countryDropdown" class="select select-primary flex-auto min-w-fit">
              <option disabled selected>Select Country</option>
            </select>
          </div>
        </div>

        <div class="grid grid-rows-2 grid-flow-col">
          <div class="text-center pb-2">Full file with geometries & attributes</div>
          <a id="downloadCountryLinkPKG" href="" class="btn btn-primary" disabled="disabled">Download GPKG</a>
        </div>

        <div class="grid grid-rows-2 grid-flow-col">
          <div class="text-center pb-2">Attributes without geometries</div>
          <a id="downloadCountryLinkCSV" href="" class="btn btn-primary" disabled="disabled">Download CSV</a>
        </div>
      </div>

      <p class="text-center">
        For details about the license, API and metadata, refer to our 
        <a class="link" href="{% url 'docs' %}">Docs</a>.
        The data is also archived on 
        <a class="link" href="https://doi.org/10.5281/zenodo.6524780">Zenodo</a>.
      </p>

      <div class="divider my-8">Or download by NUTS region</div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="grid grid-rows-2 grid-flow-col lg:col-span-1">
          <div class="text-center pb-2">NUTS (0–3)</div>
          <input list="nutsOptions" id="nutsInput"
                 class="input input-primary w-full"
                 placeholder="e.g. DE, DE1, DE12, DE123">
          <datalist id="nutsOptions"></datalist>
          <p class="text-sm text-center lg:text-left pt-2">
            Type to fuzzy-search; country choice prefilters.
          </p>
        </div>

        <div class="grid grid-rows-2 grid-flow-col lg:col-span-2">
          <div class="text-center pb-2">Matching downloads</div>
          <div id="nutsResults" class="text-sm space-y-2"></div>
        </div>
      </div>
    </div>

    <div class="container mx-auto px-4 py-4 w-full">
      <h2 class="text-center pt-16">Examples</h2>

      <div class="container mx-auto px-4 py-4 w-full">
        <div class="overflow-x-auto">
          <table class="table lg:table-fixed table-zebra w-full">
            <thead>
              <tr>
                <th>City</th>
                <th>GPKG</th>
                <th>CSV</th>
              </tr>
            </thead>
            <tbody>
              {% for example in examples %}
                <tr>
                  <td>{{ example.city | capfirst }}</td>
                  <td>
                    <a href="{{ example.gpkg_link }}" referrerpolicy="strict-origin-when-cross-origin" class="link">
                      Download full gpkg ({{ example.gpkg_size_in_mb |floatformat:1 }} Mb)
                    </a>
                  </td>
                  <td>
                    <a href="{{ example.csv_link }}" referrerpolicy="strict-origin-when-cross-origin" class="link">
                      Download csv ({{ example.csv_size_in_mb |floatformat:1 }} Mb)
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="container mx-auto px-4 py-4 w-full">
          <h2 class="pt-20 text-center">Additional Files</h2>
        </div>

        <div class="overflow-x-auto">
          <table class="table lg:table-fixed table-zebra w-full">
            <thead>
              <tr>
                <th>Name</th>
                <th>Download</th>
                <th>Info</th>
              </tr>
            </thead>
            <tbody>
              {% for file in additional_files %}
                <tr>
                  <td>{{ file.name }}</td>
                  <td>
                    <a href="{{ file.download_link }}" referrerpolicy="strict-origin-when-cross-origin" class="link">
                      Download file ({{ file.size_in_mb |floatformat:2 }} Mb)
                    </a>
                  </td>
                  <td><div class="overflow-y-auto">{{ file.info }}</div></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </article>
</div>

  {#  <div class="container mx-auto px-4 py-4 w-full">#}
  {#    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">#}
  {#      {% for example in examples %}#}
  {#        <h1>{{ example }}</h1>#}
  {#        <a id="downloadCountryLink" href="" class="btn">Download csv</a>#}
  {#        <a id="downloadCountryLink" href="" class="btn">Download pkg</a>#}
  {#      {% endfor %}#}
  {#    </div>#}
  {#  </div>#}

  <script type="module">
    let countries;
    let selectedCountry;
    let nutsPartitions = [];
    let selectedNutsId = "";
    const countryIso2 = {
      "Austria": "AT",
      "Belgium": "BE",
      "Bulgaria": "BG",
      "Croatia": "HR",
      "Cyprus": "CY",
      "Czech Republic": "CZ",
      "Germany": "DE",
      "Denmark": "DK",
      "Estonia": "EE",
      "Spain": "ES",
      "Finland": "FI",
      "France": "FR",
      "Greece": "EL",
      "Hungary": "HU",
      "Ireland": "IE",
      "Italy": "IT",
      "Lithuania": "LT",
      "Luxembourg": "LU",
      "Latvia": "LV",
      "Malta": "MT",
      "Netherlands": "NL",
      "Poland": "PL",
      "Portugal": "PT",
      "Romania": "RO",
      "Sweden": "SE",
      "Slovenia": "SI",
      "Slovakia": "SK",
      "Switzerland": "CH",
    };


    const API_URL = "{{ API_URL }}";
    const NUTS_PM_TILES_URL = "{{ NUTS_PM_TILES_URL|default:'' }}";
    let mapInstance = null;
    let applyFilters = () => {};
    const nutsInput = document.getElementById("nutsInput");
    const nutsOptions = document.getElementById("nutsOptions");

    {# NUTS partition fetch #}
    const loadNutsPartitions = async () => {
      const APIResponse = await fetch(`${API_URL}datalake/nuts?version=v0_1`);
      nutsPartitions = await APIResponse.json();
      populateNutsOptions();
    }

    const populateNutsOptions = (countryPrefix = "") => {
      const prefix = countryPrefix ? countryPrefix.toUpperCase() : "";
      const codes = new Set();
      nutsPartitions.forEach(part => {
        if (!prefix || part.nuts_id.startsWith(prefix)) {
          codes.add(part.nuts_id);
        }
      });
      nutsOptions.innerHTML = "";
      Array.from(codes).sort().forEach(code => nutsOptions.innerHTML += `<option value="${code}">`);
    }

    const renderNutsResults = () => {
      const container = document.getElementById("nutsResults");
      const candidate = (nutsInput.value || "").trim().toUpperCase();
      if (!candidate) {
        container.innerHTML = `<p class="text-center lg:text-left">Select a NUTS code (0–3) to see matching downloads.</p>`;
        selectedNutsId = "";
        updateSelectionLayer();
        applyFilters();
        return;
      }
      const matches = nutsPartitions.filter(part => part.nuts_id.toUpperCase().startsWith(candidate));
      if (matches.length === 0) {
        container.innerHTML = `<p class="text-error">No NUTS3 partitions match <span class="font-bold">${candidate}</span>.</p>`;
        selectedNutsId = candidate;
        updateSelectionLayer();
        applyFilters();
        return;
      }
      const totalFiles = matches.reduce((sum, part) => sum + part.files.length, 0);
      const version = matches[0].version;
      const s3Glob = `s3://eubucco/buildings/${version}/nuts_id=${candidate}*/`;
      selectedNutsId = candidate;
      updateSelectionLayer();
      applyFilters();
      let html = `<p>Found <span class="font-bold">${matches.length}</span> NUTS3 partition(s) (${totalFiles} file(s)) matching <span class="font-bold">${candidate}</span>.</p>`;
      const bundleUrl = `${API_URL}datalake/nuts/${version}/${candidate}/bundle`;
      html += `<p><a class="btn btn-sm btn-primary" href="${bundleUrl}" referrerpolicy="strict-origin-when-cross-origin">Download all as ZIP</a></p>`;
      html += `<p class="break-all">S3 glob for DuckDB/Polars: <code class="badge badge-outline badge-lg">${s3Glob}*.parquet</code></p>`;
      html += `<ul class="list-disc pl-4 space-y-1">`;
      matches.slice(0, 12).forEach(part => {
        const file = part.files[0];
        const sizeMb = Math.round(file.size_bytes / 1e6);
        html += `<li>${part.nuts_id} — <a class="link" href="${file.presigned_url}" referrerpolicy="strict-origin-when-cross-origin">Download (${sizeMb} MB)</a></li>`;
      });
      if (matches.length > 12) {
        html += `<li>…and ${matches.length - 12} more partitions. Use the S3 glob above to fetch all.</li>`;
      }
      html += `</ul>`;
      container.innerHTML = html;
    }

    const onNutsChange = () => renderNutsResults();

    {# Country dropdown #}
    const updateCountries = async () => {
      const APIResponse = await fetch(`${API_URL}countries`);
      countries = await APIResponse.json();
      countries.sort((a, b) => a.name.localeCompare(b.name))
      countryDropdown.innerHTML = '<option disabled selected>Select Country</option>'
      Object.entries(countries).forEach(
        ([key, country]) => countryDropdown.innerHTML += `<option value=${country.id}> ${country.name}</option>`
      );
    };


    const onSelectCountry = async () => {
      selectedCountry = countries.filter(country => country.id === parseInt(countryDropdown.options[countryDropdown.selectedIndex].value))[0]
      var download_link_csv = document.getElementById("downloadCountryLinkCSV");
      if (selectedCountry.csv === null) {
        download_link_csv.setAttribute("disabled", "disabled")
        download_link_csv.innerHTML = `Not available`
        download_link_csv.removeAttribute('href');
      } else {
        download_link_csv.setAttribute("href", selectedCountry.csv.download_link)
        download_link_csv.setAttribute("referrerpolicy", "strict-origin-when-cross-origin")
        download_link_csv.innerHTML = `Download attributes-only CSV (${Math.round(selectedCountry.csv.size_in_mb)} MB)`
        download_link_csv.removeAttribute('disabled');
      }

      var download_link_gpkg = document.getElementById("downloadCountryLinkPKG");
      if (selectedCountry.gpkg === null) {
        download_link_gpkg.setAttribute("disabled", "disabled")
        download_link_gpkg.innerHTML = `Not available`
        download_link_gpkg.removeAttribute('href');
      } else {
        download_link_gpkg.setAttribute("href", selectedCountry.gpkg.download_link)
        download_link_gpkg.setAttribute("referrerpolicy", "strict-origin-when-cross-origin")
        download_link_gpkg.innerHTML = `Download full GPKG (${Math.round(selectedCountry.gpkg.size_in_mb)} MB)`
        download_link_gpkg.removeAttribute('disabled');
      }

      // Prefilter NUTS options using country->ISO2 mapping when available
      const iso2 = countryIso2[selectedCountry.name] || "";
      populateNutsOptions(iso2);
      nutsInput.value = iso2;
      renderNutsResults();
    }

    {# MAPLIBRE + PMTILES #}
    const initMap = () => {
      if (!NUTS_PM_TILES_URL) {
        console.warn("NUTS tiles URL not configured");
        document.getElementById("nutsResults").innerHTML = `<p class="text-error">NUTS tiles not configured (set NUTS_PM_TILES_URL).</p>`;
        return;
      }
      if (!window.maplibregl) {
        console.warn("MapLibre GL JS library not loaded");
        document.getElementById("nutsResults").innerHTML = `<p class="text-error">MapLibre library not loaded.</p>`;
        return;
      }
      if (!window.pmtiles) {
        console.warn("PMTiles library not loaded (check script tag and network)");
        document.getElementById("nutsResults").innerHTML = `<p class="text-error">PMTiles library not loaded.</p>`;
        return;
      }
      const protocol = new window.pmtiles.Protocol();
      maplibregl.addProtocol("pmtiles", protocol.tile);
      const pmtilesUrl = NUTS_PM_TILES_URL.startsWith("pmtiles://") ? NUTS_PM_TILES_URL : `pmtiles://${NUTS_PM_TILES_URL}`;

      const map = new maplibregl.Map({
        container: 'map',
        style: {
          version: 8,
          sources: {
            nuts: {
              type: 'vector',
              url: pmtilesUrl,
            },
          },
          layers: [
            {
              id: 'background',
              type: 'background',
              paint: {'background-color': '#0b1221'}
            },
            {
              id: 'nuts-fill',
              type: 'fill',
              source: 'nuts',
              'source-layer': 'nuts',
              paint: {
                'fill-color': [
                  'case',
                  ['==', ['get', 'nuts_level'], 0], '#4f46e5',
                  ['==', ['get', 'nuts_level'], 1], '#22c55e',
                  ['==', ['get', 'nuts_level'], 2], '#f97316',
                  '#0ea5e9'
                ],
                'fill-opacity': ['interpolate', ['linear'], ['zoom'], 3, 0.05, 5, 0.12, 7, 0.2, 9, 0.32]
              },
              filter: ['<=', ['get', 'nuts_level'], 3]
            },
            {
              id: 'nuts-outline',
              type: 'line',
              source: 'nuts',
              'source-layer': 'nuts',
              paint: {
                'line-color': '#94a3b8',
                'line-width': ['interpolate', ['linear'], ['zoom'], 0, 0.1, 6, 0.4, 9, 0.8]
              },
              filter: ['<=', ['get', 'nuts_level'], 3]
            },
            {
              id: 'nuts-selected',
              type: 'line',
              source: 'nuts',
              'source-layer': 'nuts',
              paint: {'line-color': '#e11d48', 'line-width': 2.5},
              filter: ['==', ['get', 'nuts_id'], '']
            }
          ]
        },
        center: [10, 55],
        zoom: 3.2,
        maxZoom: 10,
        minZoom: 2.8,
        attributionControl: true,
      });
      mapInstance = map;
      window._mapInstance = map;
      map.on('error', (e) => {
        console.error("Map error", e);
        document.getElementById("nutsResults").innerHTML = `<p class="text-error">Map error: ${e?.error?.message || 'see console'}</p>`;
      });

      const updateFilterForZoom = () => {
        const z = map.getZoom();
        // When a NUTS is selected, show only its children (and keep NUTS0)
        if (selectedNutsId) {
          const targetLevel = Math.min(selectedNutsId.length - 1, 3); // nuts_level matches length-2
          const nextLevel = Math.min(targetLevel + 1, 3);
          const prefix = selectedNutsId;
          const prefixFilter = ['==', ['slice', ['get', 'nuts_id'], 0, prefix.length], prefix];
          const childrenFilter = ['all', ['==', ['get', 'nuts_level'], nextLevel], prefixFilter];
          const selectedFilter = ['all', ['==', ['get', 'nuts_id'], selectedNutsId]];
          const filter = ['any', ['==', ['get', 'nuts_level'], 0], childrenFilter, selectedFilter];
          map.setFilter('nuts-fill', filter);
          map.setFilter('nuts-outline', filter);
          return;
        }
        // Default: zoom-based visibility, keep NUTS0 always visible
        const maxLevel = z >= 6 ? 3 : z >= 5 ? 2 : z >= 3.5 ? 1 : 0;
        const filter = ['any', ['==', ['get', 'nuts_level'], 0], ['<=', ['get', 'nuts_level'], maxLevel]];
        map.setFilter('nuts-fill', filter);
        map.setFilter('nuts-outline', filter);
      };

      map.on('zoomend', updateFilterForZoom);
      map.on('load', () => {
        updateFilterForZoom();
        updateSelectionLayer();
      });
      applyFilters = updateFilterForZoom;

      map.on('click', 'nuts-fill', (e) => {
        if (!e.features || e.features.length === 0) return;
        // pick the most detailed feature clicked
        const feature = e.features.sort((a, b) => b.properties.nuts_level - a.properties.nuts_level)[0];
        selectedNutsId = feature.properties.nuts_id;
        nutsInput.value = selectedNutsId;
        renderNutsResults();
      });
    }

    const updateSelectionLayer = () => {
      if (!mapInstance) return;
      try {
        mapInstance.setFilter('nuts-selected', ['==', ['get', 'nuts_id'], selectedNutsId || '']);
      } catch (e) {
        // layer not ready yet
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById('countryDropdown').addEventListener('change', onSelectCountry);
      nutsInput.addEventListener('input', onNutsChange);
      initMap();
      renderNutsResults();
    });

    updateCountries()
    loadNutsPartitions()
  </script>
{% endblock %}
